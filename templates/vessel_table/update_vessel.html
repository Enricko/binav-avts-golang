{{define "updateVessel"}}
<div class="modal fade" id="updateVessel" tabindex="-1" role="dialog" aria-labelledby="updateVesselLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">Update Vessel <span id="updateCallSignTitle"></span></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-target="#vesselTable" data-bs-toggle="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formUpdateVessel" class="needs-validation" enctype="multipart/form-data" novalidate>
                    <input type="hidden" id="updateVesselId" name="id">
                    <div class="row g-3 mb-3">
                        <!-- <div class="col-md-6"> -->
                        <!-- <label for="updateCallSign" class="form-label">Call Sign</label> -->
                        <input type="hidden" class="form-control" id="updateCallSign" name="call_sign">
                        <!-- <div class="invalid-feedback">Please provide a call sign.</div> -->
                        <!-- </div> -->
                        <div class="col-md-6">
                            <label for="updateFlag" class="form-label">Flag</label>
                            <input type="text" class="form-control" id="updateFlag" name="flag" required>
                            <div class="invalid-feedback">Please provide a flag.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="updateKelas" class="form-label">Class</label>
                            <input type="text" class="form-control" id="updateKelas" name="kelas" required>
                            <div class="invalid-feedback">Please provide a class.</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="updateBuilder" class="form-label">Builder</label>
                            <input type="text" class="form-control" id="updateBuilder" name="builder" required>
                            <div class="invalid-feedback">Please provide a builder.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="updateYearBuilt" class="form-label">Year Built</label>
                            <input type="number" class="form-control" id="updateYearBuilt" name="year_built" min="1800" max="{{.CurrentYear}}"
                                required>
                            <div class="invalid-feedback">Please provide a valid year.</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="updateHeadingDirection" class="form-label">Heading Direction</label>
                            <input type="number" class="form-control" id="updateHeadingDirection" name="heading_direction" required>
                            <div class="invalid-feedback">Please provide a valid direction.</div>
                        </div>
                        <div class="col-md-6">
                            <label for="updateCalibration" class="form-label">Calibration</label>
                            <input type="number" class="form-control" id="updateCalibration" name="calibration" required>
                            <div class="invalid-feedback">Please provide a calibration value.</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-3">
                            <label for="updateWidthM" class="form-label">Width (m)</label>
                            <input type="number" class="form-control" id="updateWidthM" name="width_m" min="0" required>
                            <div class="invalid-feedback">Please provide a valid width.</div>
                        </div>
                        <div class="col-md-3">
                            <label for="updateHeight" class="form-label">Height (m)</label>
                            <input type="number" class="form-control" id="updateHeight" name="height_m" min="0" required>
                            <div class="invalid-feedback">Please provide a valid height.</div>
                        </div>
                        <div class="col-md-3">
                            <label for="updateTopRange" class="form-label">Top Range</label>
                            <input type="number" class="form-control" id="updateTopRange" name="top_range" min="0" required>
                            <div class="invalid-feedback">Please provide a valid top range.</div>
                        </div>
                        <div class="col-md-3">
                            <label for="updateLeftRange" class="form-label">Left Range</label>
                            <input type="number" class="form-control" id="updateLeftRange" name="left_range" min="0" required>
                            <div class="invalid-feedback">Please provide a valid left range.</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label for="updateHistoryPerSecond" class="form-label">History Per Second</label>
                            <input type="number" class="form-control" id="updateHistoryPerSecond" name="history_per_second" min="1" value="1"
                                required>
                            <div class="invalid-feedback">Please provide a valid value (minimum 1).</div>
                        </div>
                        <div class="col-md-4">
                            <label for="updateMinimumKnotPerLiterGasoline" class="form-label">Min Knot/Liter Gasoline</label>
                            <input type="number" class="form-control" id="updateMinimumKnotPerLiterGasoline" name="minimum_knot_per_liter_gasoline"
                                min="0" step="0.01" required>
                            <div class="invalid-feedback">Please provide a valid minimum knot per liter.</div>
                        </div>
                        <div class="col-md-4">
                            <label for="updateMaximumKnotPerLiterGasoline" class="form-label">Max Knot/Liter Gasoline</label>
                            <input type="number" class="form-control" id="updateMaximumKnotPerLiterGasoline" name="maximum_knot_per_liter_gasoline"
                                min="0" step="0.01" required>
                            <div class="invalid-feedback">Please provide a valid maximum knot per liter.</div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label for="updateImageMap" class="form-label">Image Map (Leave empty to keep current)</label>
                            <input type="file" class="form-control" id="updateImageMap" name="image_map" accept="image/*">
                        </div>
                        <div class="col-md-6">
                            <label for="updateImage" class="form-label">Vessel Image (Leave empty to keep current)</label>
                            <input type="file" class="form-control" id="updateImage" name="image" accept="image/*">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="recordStatus" class="form-label">Record Status</label>
                        <select class="form-select" id="updateRecordStatus" name="record_status" required>
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                        <div class="invalid-feedback">Please select a status.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-target="#vesselTable" data-bs-toggle="modal">Cancel</button>
                <button type="submit" id="updateVesselButton" class="btn btn-primary">Update</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('formUpdateVessel');
        const updateButton = document.getElementById('updateVesselButton');
        let originalFormData;
    
        function getFormData(form) {
            const formData = new FormData(form);
            return Object.fromEntries(formData.entries());
        }
    
        function objectsEqual(obj1, obj2) {
            return JSON.stringify(obj1) === JSON.stringify(obj2);
        }
    
        const updateVesselModal = document.getElementById('updateVessel');
        updateVesselModal.addEventListener('shown.bs.modal', function () {
            originalFormData = getFormData(form);
        });
    
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            event.stopPropagation();
            
            if (this.checkValidity()) {
                const currentFormData = getFormData(this);
                
                if (objectsEqual(originalFormData, currentFormData)) {
                    Swal.fire({
                        title: 'No Changes Detected',
                        text: 'The form data remains unchanged. No update is necessary.',
                        icon: 'info',
                    });
                    return;
                }
    
                const formData = new FormData(this);
                const vesselId = formData.get('id');
            
                ['year_built', 'heading_direction', 'calibration', 'width_m', 'height_m', 'top_range', 'left_range', 'history_per_second'].forEach(function(field) {
                    const value = formData.get(field);
                    if (value === "") {
                        formData.set(field, "0");
                    }
                });
    
                ['minimum_knot_per_liter_gasoline', 'maximum_knot_per_liter_gasoline'].forEach(function(field) {
                    const value = formData.get(field);
                    if (value === "") {
                        formData.set(field, "0");
                    } else {
                        formData.set(field, parseFloat(value).toString());
                    }
                });
    
                formData.set('record_status', formData.get('record_status') === 'true');
    
                Swal.fire({
                    title: 'Updating...',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    },
                });
    
                fetch(`/vessel/update/${vesselId}`, {
                    method: 'PUT',
                    body: formData,
                    headers: {
                        "X-CSRF-Token": getCsrfToken(),
                    },
                })
                .then(response => {
                    Swal.close();
                    if (!response.ok) {
                        return response.json().then(err => { throw err; });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Vessel updated:', data);
                    dataTableMap["vessel-table"].dataTable.ajax.reload();
                    const updateVesselModal = document.getElementById('updateVessel');
                    const modalInstance = bootstrap.Modal.getInstance(updateVesselModal);
                    modalInstance.hide();
    
                    const vesselTableModal = document.getElementById('vesselTable');
                    const vesselTableModalInstance = new bootstrap.Modal(vesselTableModal);
                    vesselTableModalInstance.show();
    
                    form.reset();
                    form.classList.remove('was-validated');
                    Swal.fire({
                        title: 'Success',
                        text: data.message || 'Vessel updated successfully',
                        icon: 'success',
                    });
                })
                .catch(error => {
                    console.error('Error updating vessel:', error);
                    Swal.fire({
                        title: 'Error',
                        text: error.message || 'An error occurred while updating the vessel',
                        icon: 'error',
                    });
                });
            }
            
            this.classList.add('was-validated');
        });
    
        updateButton.addEventListener('click', function() {
            form.requestSubmit();
        });
    
        ['updateImageMap', 'updateImage'].forEach(function(inputId) {
            const input = document.getElementById(inputId);
            input.addEventListener('change', function() {
                const fileName = this.value.split('\\').pop();
                const label = this.nextElementSibling;
                if (label && label.classList.contains('custom-file-label')) {
                    label.textContent = fileName;
                }
            });
        });
    
        updateVesselModal.addEventListener('hidden.bs.modal', function () {
            form.reset();
            form.classList.remove('was-validated');
            document.querySelectorAll('.custom-file-label').forEach(label => {
                label.textContent = 'Choose file';
            });
        });
    });
    </script>
{{end}}